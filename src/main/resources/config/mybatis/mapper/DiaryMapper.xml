<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.product.luffy.mapper.DiaryMapper" >
  
  <resultMap id="DiaryResultMap" type="com.product.luffy.po.Diary">
  	<id 	column="DIARY_ID" 			property="diaryId"/>
  	<result column="TITLE"				property="title"/>
  	<result column="CONTENT"    		property="content"/>
  	<result column="REG_USER_ID"    	property="regUserId"/>
  	<result column="FILE_ID"    		property="fileId"/>
  	<result column="STATE_ID"    		property="stateId"/>
  	<result column="FEELING_CD"     	property="feelingCd"/>
  	<result column="HEALTH_CD"    		property="healthCd"/>
  	<result column="FEVER_CD"    		property="feverCd"/>
  	<result column="BREAKFAST_CD"   	property="breakfastCd"/>
  	<result column="LUNCH_CD"    		property="lunchCd"/>
  	<result column="DINNER_CD"    		property="dinnerCd"/>
  	<result column="SHIT_CD"    		property="shitCd"/>
  	<result column="SHIT_CNT"    		property="shitCnt"/>
  	<result column="SHIT_DESC"    		property="shitDesc"/>
  	<result column="SLEEP_START_TIME"   property="sleepStartTime"/>
  	<result column="SLEEP_END_TIME"    	property="sleepEndTime"/>
  	<result column="REG_DTM"    		property="regDtm"/>
 	<result column="CHG_REG_DTM"        property="chgRegDtm"/>
 	<result column="HEADER_TITLE"       property="headerTitle"/>
  </resultMap>
  
  <select id="selectDiaryList" parameterType="map" resultMap="DiaryResultMap">
		SELECT A.DIARY_ID,
		       A.TITLE,
		       A.CONTENT,
		       A.REG_USER_ID,
		       A.FILE_ID,
		       B.STATE_ID,
		       (SELECT C.CD_VAL FROM CD_DTL_F C WHERE B.FEELING_CD = C.CD_DTL_ID)   AS FEELING_CD,
		       (SELECT C.CD_VAL FROM CD_DTL_F C WHERE B.HEALTH_CD = C.CD_DTL_ID)    AS HEALTH_CD,
		       (SELECT C.CD_VAL FROM CD_DTL_F C WHERE B.FEVER_CD = C.CD_DTL_ID)     AS FEVER_CD,
		       (SELECT C.CD_VAL FROM CD_DTL_F C WHERE B.BREAKFAST_CD = C.CD_DTL_ID) AS BREAKFAST_CD,
		       (SELECT C.CD_VAL FROM CD_DTL_F C WHERE B.LUNCH_CD = C.CD_DTL_ID)     AS LUNCH_CD,
		       (SELECT C.CD_VAL FROM CD_DTL_F C WHERE B.DINNER_CD = C.CD_DTL_ID)    AS DINNER_CD,
		       (SELECT C.CD_VAL FROM CD_DTL_F C WHERE B.SHIT_CD = C.CD_DTL_ID)      AS SHIT_CD,
		       B.SHIT_CNT,
		       B.SHIT_DESC,
		       B.SLEEP_START_TIME,
		       B.SLEEP_END_TIME,
		       CAST(DATE_FORMAT(A.REG_DTM, '%Y년 %c월 %e일 %k시 %i분') AS CHAR) AS REG_DTM,
		       CONCAT(CAST(DATE_FORMAT(A.REG_DTM, '%Y.%c.%e ') AS CHAR), CASE DAYOFWEEK(A.REG_DTM)
		          WHEN '1' THEN '(일)'
		          WHEN '2' THEN '(월)'
		          WHEN '3' THEN '(화)'
		          WHEN '4' THEN '(수)'
		          WHEN '5' THEN '(목)'
		          WHEN '6' THEN '(금)'
		          WHEN '7' THEN '(토)'
		       END) AS HEADER_TITLE
		  FROM DIARY_F A INNER JOIN STATE_F B ON A.DIARY_ID = B.DIARY_ID
		 WHERE A.REG_USER_ID = #{regUserId}
		ORDER BY A.REG_DTM DESC
  </select>
  
  <select id="selectDiary" parameterType="map" resultMap="DiaryResultMap">  
		SELECT A.DIARY_ID,
		       A.TITLE,
		       A.CONTENT,
		       A.REG_USER_ID,
		       A.FILE_ID,
		       B.STATE_ID,
		       B.FEELING_CD,
		       B.HEALTH_CD,
		       B.FEVER_CD,
		       B.BREAKFAST_CD,
		       B.LUNCH_CD,
		       B.DINNER_CD,
		       B.SHIT_CD,
		       B.SHIT_CNT,
		       B.SHIT_DESC,
		       B.SLEEP_START_TIME,
		       B.SLEEP_END_TIME,
		       CAST(DATE_FORMAT(A.REG_DTM, '%Y년 %c월 %e일 %k시 %i분') AS CHAR) AS REG_DTM,
		       CONCAT(CAST(DATE_FORMAT(A.REG_DTM, '%Y.%c.%e ') AS CHAR), CASE DAYOFWEEK(A.REG_DTM)
		          WHEN '1' THEN '(일)'
		          WHEN '2' THEN '(월)'
		          WHEN '3' THEN '(화)'
		          WHEN '4' THEN '(수)'
		          WHEN '5' THEN '(목)'
		          WHEN '6' THEN '(금)'
		          WHEN '7' THEN '(토)'
		       END) AS CHG_REG_DTM
		  FROM DIARY_F A INNER JOIN STATE_F B ON A.DIARY_ID = B.DIARY_ID
		 WHERE A.REG_USER_ID = #{regUserId} 
		   AND A.DIARY_ID = #{diaryId}
  </select>
 
  <insert id="insertDiary" parameterType="com.product.luffy.po.Diary">
	  INSERT INTO `DIARY_F`(`DIARY_ID`,
	                      `TITLE`,
	                      `CONTENT`,
	                      `REG_USER_ID`,
	                      `FILE_ID`,
	                      `REG_DTM`)
		VALUES (#{diaryId},
		        #{title},
		        #{content},
		        #{regUserId},
		        #{fileId},
		        NOW())
  </insert> 	
  
  <insert id="insertState" parameterType="com.product.luffy.po.Diary">
	  INSERT INTO `STATE_F`(`STATE_ID`,
	                      `DIARY_ID`,
	                      `FEELING_CD`,
	                      `HEALTH_CD`,
	                      `FEVER_CD`,
	                      `BREAKFAST_CD`,
	                      `LUNCH_CD`,
	                      `DINNER_CD`,
	                      `SHIT_CD`,
	                      `SHIT_CNT`,
	                      `SHIT_DESC`,
	                      `SLEEP_START_TIME`,
	                      `SLEEP_END_TIME`,
	                      `REG_DTM`)
		VALUES (#{stateId},
		        #{diaryId},
		        #{feelingCd},
		        #{healthCd},
		        #{feverCd},
		        #{breakfastCd},
		        #{lunchCd},
		        #{dinnerCd},
		        #{shitCd},
		        #{shitCnt},
		        #{shitDesc},
		        #{sleepStartTime},
		        #{sleepEndTime},
		        NOW())
  </insert>
  
  <update id="updateDiary" parameterType="com.product.luffy.po.Diary">
	UPDATE DIARY_F
	   SET TITLE = #{title}, 
	   CONTENT = #{content},
	   FILE_ID = #{fileId}
	 WHERE DIARY_ID = #{diaryId}
  </update>
  
  <update id="updateState" parameterType="com.product.luffy.po.Diary">
	  UPDATE STATE_F
	   SET FEELING_CD = #{feelingCd},
	       HEALTH_CD = #{healthCd},
	       FEVER_CD = #{feverCd},
	       BREAKFAST_CD = #{breakfastCd},
	       LUNCH_CD = #{lunchCd},
	       DINNER_CD = #{dinnerCd},
	       SHIT_CD = #{shitCd},
	       SHIT_CNT = #{shitCnt},
	       SHIT_DESC = #{shitDesc},
	       SLEEP_START_TIME = #{sleepStartTime},
	       SLEEP_END_TIME = #{sleepEndTime}
	 WHERE DIARY_ID = #{diaryId};
  </update>
  
</mapper>
